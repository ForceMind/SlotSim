<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slot Machine Simulation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { padding-top: 20px; background-color: #f8f9fa; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: #0d6efd; }
        .stat-label { color: #6c757d; font-size: 0.9rem; }
        #loading { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4 text-center">Slot Machine Simulation Tool</h1>
        
        <div class="card">
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-4">
                        <label for="configFiles" class="form-label">配置文件 (Upload Excel Files)</label>
                        <input type="file" class="form-control" id="configFiles" multiple accept=".xlsx">
                        <div class="form-text" style="font-size: 0.7rem;">Select Payout.xlsx, SlotNormal.xlsx, WinLine.xlsx</div>
                    </div>
                    <div class="col-md-2">
                        <label for="wildId" class="form-label">百搭ID (Wild)</label>
                        <input type="number" class="form-control" id="wildId" placeholder="e.g. 11">
                    </div>
                    <div class="col-md-3">
                        <label for="numSpins" class="form-label">模拟次数 (Spins)</label>
                        <input type="number" class="form-control" id="numSpins" value="100000" min="1000" max="1000000">
                    </div>
                    <div class="col-md-3">
                        <button id="runBtn" class="btn btn-primary w-100">开始模拟 (Run)</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="loading" class="text-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">正在模拟中，请稍候... (Simulating...)</p>
        </div>

        <div id="results" style="display: none;">
            <!-- Key Metrics -->
            <div class="row">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="stat-label">RTP (玩家回报率)</div>
                            <div class="stat-value" id="rtp">--%</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="stat-label">Hit Rate (中奖率)</div>
                            <div class="stat-value" id="hitRate">--%</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="stat-label">Volatility (波动率/标准差)</div>
                            <div class="stat-value" id="volatility">--</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="stat-label">Max Win (最大赢分)</div>
                            <div class="stat-value" id="maxWin">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">95% Confidence Interval for RTP</h5>
                            <p class="card-text text-center" id="ciText">--</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Win Distribution (中奖分布)</h5>
                            <canvas id="winDistChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Symbol Win Contribution (图标赢分贡献)</h5>
                            <canvas id="symbolWinChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Table -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Symbol Statistics (图标详细统计)</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Symbol ID</th>
                                    <th>Hits 3x</th>
                                    <th>Hits 4x</th>
                                    <th>Hits 5x</th>
                                    <th>Total Win (总赢分)</th>
                                    <th>% of Total Win</th>
                                </tr>
                            </thead>
                            <tbody id="symbolTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let winDistChart = null;
        let symbolWinChart = null;

        document.getElementById('runBtn').addEventListener('click', async () => {
            const numSpins = document.getElementById('numSpins').value;
            const wildId = document.getElementById('wildId').value;
            const fileInput = document.getElementById('configFiles');
            
            if (fileInput.files.length === 0) {
                alert("请选择配置文件 (Please select Payout, SlotNormal, WinLine files).");
                return;
            }
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('runBtn').disabled = true;

            const formData = new FormData();
            formData.append('num_spins', numSpins);
            formData.append('wild_id', wildId);
            
            for (let i = 0; i < fileInput.files.length; i++) {
                formData.append('files[]', fileInput.files[i]);
            }

            try {
                const response = await fetch('/run_simulation', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                displayResults(data);
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while running the simulation.');
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('runBtn').disabled = false;
            }
        });

        function displayResults(data) {
            document.getElementById('results').style.display = 'block';
            
            // Key Metrics
            document.getElementById('rtp').textContent = (data.rtp * 100).toFixed(2) + '%';
            document.getElementById('hitRate').textContent = (data.hit_rate * 100).toFixed(2) + '%';
            document.getElementById('volatility').textContent = data.volatility.toFixed(4);
            document.getElementById('maxWin').textContent = data.max_win.toFixed(2);
            
            const ciLower = (data.ci_95[0] * 100).toFixed(2);
            const ciUpper = (data.ci_95[1] * 100).toFixed(2);
            document.getElementById('ciText').textContent = `[ ${ciLower}% , ${ciUpper}% ]`;

            // Charts
            updateCharts(data);

            // Table
            const tbody = document.getElementById('symbolTableBody');
            tbody.innerHTML = '';
            
            const sortedSyms = Object.keys(data.symbol_hits).sort((a, b) => parseInt(a) - parseInt(b));
            
            sortedSyms.forEach(sym => {
                const hitsDict = data.symbol_hits[sym];
                const h3 = hitsDict['3'] || 0;
                const h4 = hitsDict['4'] || 0;
                const h5 = hitsDict['5'] || 0;
                const win = data.symbol_win_amounts[sym];
                const pct = data.total_win > 0 ? (win / data.total_win * 100) : 0;
                
                const row = `<tr>
                    <td>${sym}</td>
                    <td>${h3}</td>
                    <td>${h4}</td>
                    <td>${h5}</td>
                    <td>${win.toFixed(2)}</td>
                    <td>${pct.toFixed(2)}%</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        function updateCharts(data) {
            // Win Distribution Chart
            const distLabels = ["< 1x Bet", "1x - 5x Bet", "5x - 10x Bet", "10x - 20x Bet", "20x - 50x Bet", "50x - 100x Bet", "100x+ Bet"];
            const distData = distLabels.map(label => data.win_distribution[label] || 0);
            
            const ctxDist = document.getElementById('winDistChart').getContext('2d');
            if (winDistChart) winDistChart.destroy();
            
            winDistChart = new Chart(ctxDist, {
                type: 'bar',
                data: {
                    labels: distLabels,
                    datasets: [{
                        label: 'Count',
                        data: distData,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } }
                }
            });

            // Symbol Win Chart
            const symLabels = Object.keys(data.symbol_win_amounts).sort((a, b) => parseInt(a) - parseInt(b));
            const symData = symLabels.map(sym => data.symbol_win_amounts[sym]);
            
            const ctxSym = document.getElementById('symbolWinChart').getContext('2d');
            if (symbolWinChart) symbolWinChart.destroy();
            
            symbolWinChart = new Chart(ctxSym, {
                type: 'pie',
                data: {
                    labels: symLabels.map(s => 'ID ' + s),
                    datasets: [{
                        data: symData,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', 
                            '#FF9F40', '#C9CBCF', '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }
    </script>
</body>
</html>
